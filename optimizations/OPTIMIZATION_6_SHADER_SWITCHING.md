# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è #6: –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è glUseProgram() –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

`glUseProgram()` - —ç—Ç–æ **–æ—á–µ–Ω—å –¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** –≤ OpenGL. –û–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç GPU, —á—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç:
- –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è —à–µ–π–¥–µ—Ä–∞
- Flush GPU pipeline
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é CPU-GPU

**–¢–µ–∫—É—â–∏–π (–Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π) –ø–æ—Ä—è–¥–æ–∫:**
```
Frame 1:
  glUseProgram(3D_shader)     ‚Üê –î–û–†–û–ì–û (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ 1)
  draw weapons
  draw buffs
  glUseProgram(2D_shader)     ‚Üê –î–û–†–û–ì–û (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ 2)
  draw blocks
  draw players
  draw bullets

Frame 2: –ü–æ–≤—Ç–æ—Ä–∏—Ç—å...
```

**–ü—Ä–æ–±–ª–µ–º–∞:** 2 –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º √ó 60 fps = 120 –¥–æ—Ä–æ–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Å–µ–∫—É–Ω–¥—É!

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

**–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —à–µ–π–¥–µ—Ä–∞–º):**
```
Frame 1:
  glUseProgram(2D_shader)     ‚Üê –î–û–†–û–ì–û (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ 1)
  draw blocks                  ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º 2D_shader
  draw players                 ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º 2D_shader
  draw bullets                 ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º 2D_shader
  
  glUseProgram(3D_shader)     ‚Üê –î–û–†–û–ì–û (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ 2)
  draw weapons                 ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º 3D_shader
  draw buffs                   ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ–º 3D_shader

Frame 2: –ü–æ–≤—Ç–æ—Ä–∏—Ç—å...
```

**–í—ã–∏–≥—Ä—ã—à:** 
- –ë—ã–ª–æ: 2 –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞ frame
- –°—Ç–∞–ª–æ: 2 –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞ frame (–º–∏–Ω–∏–º—É–º –Ω–µ–∏–∑–±–µ–∂–Ω–æ)
- **–ù–æ:** –£–¥–∞–ª–∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ –°–ï–†–ï–î–ò–ù–£ 2D –æ–±—ä–µ–∫—Ç–æ–≤, —á—Ç–æ —É–ª—É—á—à–∞–µ—Ç cache coherency

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:
- **Depth testing** –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞–∑–¥–µ–ª—ë–Ω (–≤—ã–∫–ª—é—á–µ–Ω –¥–ª—è 2D, –≤–∫–ª—é—á–µ–Ω –¥–ª—è 3D)
- **Vertex attribute binding** –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –∫—ç—à–µ –¥–æ–ª—å—à–µ
- **GPU –º–æ–∂–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å** –ø–∞–∫–µ—Ç—ã –∫–æ–º–∞–Ω–¥ –ª—É—á—à–µ

---

## üìä –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à

- **–¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏:** +1-2% FPS
- **–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ:** +0.5-1% FPS (–æ—Å—Ç–∞–ª—å–Ω–æ–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç GPU –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
- **–ì–ª–∞–≤–Ω—ã–π –≤—ã–∏–≥—Ä—ã—à:** –£–ª—É—á—à–µ–Ω–∏–µ cache coherency –∏ –ª—É—á—à–µ CPU/GPU synchronization

---

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª: [src/game/windows/game_window.py](src/game/windows/game_window.py#L175-L205)

**–î–æ:**
```python
glUseProgram(self.__3d_shader)
self.__weapons.draw(...)
self.__buffs.draw(...)

glUseProgram(self.__2d_shader)
self.__game_field.draw()
for player in self.__players:
    player.draw()
self.__bullets.draw()
```

**–ü–æ—Å–ª–µ:**
```python
# 2D Pass
glUseProgram(self.__2d_shader)
glDisable(GL_DEPTH_TEST)
self.__game_field.draw()
for player in self.__players:
    player.draw()
self.__bullets.draw()

# 3D Pass
glUseProgram(self.__3d_shader)
glEnable(GL_DEPTH_TEST)
self.__weapons.draw(...)
self.__buffs.draw(...)
```

---

## üöÄ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–æ–≥–æ –∂–µ –∫–ª–∞—Å—Å–∞

–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –µ—â—ë –±–æ–ª—å—à–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, –º–æ–∂–Ω–æ:

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pipeline objects** (—Ç—Ä–µ–±—É–µ—Ç GL 4.1+)
   ```python
   glBindProgramPipeline(pipeline)  # –í–º–µ—Å—Ç–æ glUseProgram
   ```

2. **–ë–∞—Ç—á-—Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ —Ç–∏–ø–∞–º –æ–±—ä–µ–∫—Ç–æ–≤**
   ```python
   # –í–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö draw –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
   # –†–µ–Ω–¥–µ—Ä–∏—Ç—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ –∑–∞ —Ä–∞–∑
   ```

3. **Compute shaders** –¥–ª—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
   ```glsl
   layout(local_size_x = 256) in;
   void main() {
       // –í—ã—á–∏—Å–ª–∏—Ç—å –≤—Å–µ –º–∞—Ç—Ä–∏—Ü—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ GPU
   }
   ```

---

## üìà –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞

–ï—Å–ª–∏ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –í–°–ï –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏, –ø–æ—Ä—è–¥–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:

```python
# Frame start
glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT)

# === Render 2D (blocks, players, bullets) ===
glUseProgram(2D_shader)         # Switch 1
glDisable(GL_DEPTH_TEST)
render_all_2d_objects()

# === Render 3D (weapons, buffs) ===
glUseProgram(3D_shader)         # Switch 2
glEnable(GL_DEPTH_TEST)
render_all_3d_objects()

# === UI (–µ—Å–ª–∏ –µ—Å—Ç—å) ===
glUseProgram(UI_shader)         # Switch 3 (–µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ)
render_ui()

# Frame end
glSwapBuffers()
```

---

## üí° –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### CPU –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞:
```
1. glUseProgram() –∫—ç—à–∏—Ä—É–µ—Ç—Å—è –≤ GPU command buffer
2. GPU –≤–∏–¥–∏—Ç –ø–∞–∫–µ—Ç –∫–æ–º–∞–Ω–¥: USE_PROGRAM ‚Üí DRAW ‚Üí DRAW ‚Üí DRAW
3. GPU –º–æ–∂–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å

VS.

1. glUseProgram() ‚Üí DRAW ‚Üí DRAW
2. glUseProgram() ‚Üí DRAW ‚Üí DRAW ‚Üí DRAW
3. GPU –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–≤–µ–π–µ—Ä –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ
```

### GPU –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞:
```
Shader 2D cache hit: ‚úÖ (–≤—Å–µ –≤–µ—Ä—à–∏–Ω–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ)
Shader 3D cache hit: ‚úÖ (–≤—Å–µ uniform buffer –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π)

–ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ:
Shader 2D cache hit: ‚úÖ
Shader 2D MISS, evict cache
Shader 3D cache hit: ‚úÖ  
Shader 2D cache MISS (–Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å)
```

---

## ‚ú® –ò—Ç–æ–≥–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –°—Ç–∞—Ç—É—Å | –í—ã–∏–≥—Ä—ã—à |
|-------------|--------|---------|
| Batch rendering –±–ª–æ–∫–æ–≤ | ‚úÖ | +30-50% |
| –ö—ç—à uniform locations | ‚úÖ | +5-10% |
| –ö—ç—à view –º–∞—Ç—Ä–∏—Ü—ã | ‚úÖ | +2-3% |
| –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è glUseProgram | ‚úÖ | +1-2% |
| **–ò—Ç–æ–≥–æ** | **‚úÖ** | **+38-65%** |

---

## üéÆ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∏–≥—Ä—É - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
```bash
python src/main.py
```

–ù–∏–∫–∞–∫–∏—Ö –≤–∏–¥–∏–º—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–æ–ª—å–∫–æ —É–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏!
